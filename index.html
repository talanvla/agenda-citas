<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agendar Cita</title>
</head>
<body>

<h1>Agenda tu cita</h1>

<label>Servicio:</label>
<select id="services">
  <option value="">Cargando servicios...</option>
</select>
<br><br>

<label>Fecha:</label>
<input type="date" id="date">
<br><br>

<label>Hora:</label>
<select id="time">
  <option value="">Selecciona una fecha</option>
</select>
<br><br>

<label>Nombre:</label>
<input type="text" id="name">
<br><br>

<label>Email:</label>
<input type="email" id="email">
<br><br>

<label>Dirección de escaneo:</label>
<input type="text" id="direccion">
<br><br>

<label>Método de pago:</label>
<select id="payment_method">
  <option value="yape">Yape</option>
  <option value="plin">Plin</option>
</select>
<br><br>

<label>Subir comprobante (imagen):</label>
<input type="file" id="voucher">
<br><br>

<h3>Distritos sin costo adicional:</h3>
<p>
San Isidro, San Borja, Miraflores,<br>
San Miguel, Magdalena, Jesús María, Surco
</p>

<h4>Consideraciones</h4>
<p>
Para reservar la cita se debe abonar S/100<br>
como garantía al yape/plin 955507470 de Andres Talavera.<br>
La diferencia al culminar el servicio.<br><br>
Teléfono: +51972598538 – IG: @predicar.pe
</p>

<p>Ingeniero Mecatrónico – Andres Talavera</p>

<button onclick="book()">Agendar</button>
<p id="result"></p>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
/* ===============================
   SUPABASE
================================ */
const SUPABASE_URL = "https://lseahxqxcnmwfruoaubt.supabase.co";
const SUPABASE_KEY = "PEGA_AQUI_TU_ANON_PUBLIC_KEY";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===============================
   CARGAR SERVICIOS
================================ */
async function loadServices() {
  const { data, error } = await db
    .from("services")
    .select("id, name");

  if (error) {
    console.error(error);
    document.getElementById("services").innerHTML =
      `<option value="">Error cargando servicios</option>`;
    return;
  }

  let html = `<option value="">Selecciona un servicio</option>`;
  data.forEach(s => {
    html += `<option value="${s.id}">${s.name}</option>`;
  });

  document.getElementById("services").innerHTML = html;
}

/* ===============================
   CARGAR HORARIOS
   (BLOQUEO POR RANGO)
================================ */
async function loadTimes() {
  const date = document.getElementById("date").value;
  const timeSelect = document.getElementById("time");

  timeSelect.innerHTML = "";

  if (!date) {
    timeSelect.innerHTML =
      `<option value="">Selecciona una fecha</option>`;
    return;
  }

  const now = new Date();
  const todayStr = now.toISOString().split("T")[0];

  if (new Date(date) < new Date(todayStr)) {
    timeSelect.innerHTML =
      `<option value="">Fecha no válida</option>`;
    return;
  }

  const { data: ap } = await db
    .from("appointments")
    .select("time")
    .eq("date", date);

  const { data: bl } = await db
    .from("blocked_times")
    .select("time, is_full_day, start_date, end_date")
    .lte("start_date", date)
    .gte("end_date", date);

  if (bl && bl.some(b => b.is_full_day === true)) {
    timeSelect.innerHTML =
      `<option value="">Día no disponible</option>`;
    return;
  }

  const allTimes = ["08:00","10:30","13:00","15:00"];

  const occupied = [
    ...(ap || []).map(a => a.time),
    ...(bl || []).filter(b => !b.is_full_day).map(b => b.time)
  ];

  const free = allTimes.filter(t => {
    if (occupied.includes(t)) return false;

    const slot = new Date(`${date}T${t}:00`);
    if (date === todayStr && slot < now) return false;

    const diffHours = (slot - now) / 3600000;
    if (date === todayStr && diffHours < 2) return false;

    return true;
  });

  if (free.length === 0) {
    timeSelect.innerHTML =
      `<option value="">Sin horarios disponibles</option>`;
    return;
  }

  free.forEach(t => {
    timeSelect.innerHTML += `<option value="${t}">${t}</option>`;
  });
}

/* ===============================
   AGENDAR CITA
================================ */
async function book() {
  const time = document.getElementById("time").value;

  if (!time) {
    document.getElementById("result").textContent =
      "Debes seleccionar una hora válida.";
    return;
  }

  const fileInput = document.getElementById("voucher");
  if (fileInput.files.length === 0) {
    document.getElementById("result").textContent =
      "Debes subir el comprobante.";
    return;
  }

  const file = fileInput.files[0];
  const fileName = Date.now() + "_" + file.name;

  const { error: uploadError } = await db.storage
    .from("yape-comprobantes")
    .upload(fileName, file);

  if (uploadError) {
    console.error(uploadError);
    document.getElementById("result").textContent =
      uploadError.message;
    return;
  }

  const { data: publicUrl } = db.storage
    .from("yape-comprobantes")
    .getPublicUrl(fileName);

  const { error } = await db.from("appointments").insert({
    service_id: document.getElementById("services").value,
    client_name: document.getElementById("name").value,
    client_email: document.getElementById("email").value,
    direccion: document.getElementById("direccion").value,
    date: document.getElementById("date").value,
    time,
    payment_method: document.getElementById("payment_method").value,
    status: "pending",
    created_at: new Date().toISOString()
  });

  if (error) {
    console.error(error);
    document.getElementById("result").textContent =
      error.message;
    return;
  }

  await db.from("yape_payments").insert({
    imagen_url: publicUrl.publicUrl,
    created_at: new Date().toISOString()
  });

  document.getElementById("result").textContent =
    "✅ Cita registrada correctamente";
}

/* ===============================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", () => {
  loadServices();
  document.getElementById("date").addEventListener("change", loadTimes);
});
</script>

</body>
</html>
