<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agendar Cita</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      background: #f4f6f8;
      color: #333;
    }

    .hero {
      background: #111;
      padding: 30px 20px;
    }

    .hero-images {
      max-width: 1100px;
      margin: auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .hero-images img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 12px;
    }

    .container {
      max-width: 900px;
      margin: -40px auto 40px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 30px;
    }

    h1 {
      text-align: center;
      margin-top: 0;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    input[type="file"] {
      padding: 6px;
    }

    button {
      margin-top: 25px;
      background: #2d5bff;
      color: white;
      border: none;
      padding: 14px;
      width: 100%;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      background: #1f45cc;
    }

    p {
      line-height: 1.5;
    }

    #result {
      margin-top: 15px;
      font-weight: 600;
      text-align: center;
    }
  </style>
</head>

<body>

<!-- IM√ÅGENES DECORATIVAS -->
<div class="hero">
  <div class="hero-images">
    <img src="https://images.unsplash.com/photo-1549924231-f129b911e442">
    <img src="https://images.unsplash.com/photo-1503376780353-7e6692767b70">
    <img src="https://images.unsplash.com/photo-1542362567-b07e54358753">
  </div>
</div>

<div class="container">

  <!-- TEXTO ORIGINAL -->
  <h1>Agenda tu cita</h1>

  <label>Servicio:</label>
  <select id="services"></select>

  <label>Fecha:</label>
  <input type="date" id="date">

  <label>Hora:</label>
  <select id="time"></select>

  <label>Nombre:</label>
  <input type="text" id="name">

  <label>Email:</label>
  <input type="email" id="email">

  <label>Direcci√≥n de escaneo:</label>
  <input type="text" id="direccion">

  <label>M√©todo de pago:</label>
  <select id="payment_method">
    <option value="yape">Yape</option>
    <option value="plin">Plin</option>
  </select>

  <label>Subir comprobante (imagen):</label>
  <input type="file" id="voucher">

  <h3>Distritos sin costo adicional:</h3>
  <p>
    San Isidro, San Borja, Miraflores, <br>
    San Miguel, Magdalena, Jes√∫s Mar√≠a, Surco
  </p>

  <h4>Consideraciones </h4>
  <p>
    Para reservar la cita se debe abonar S/100 <br>
    como garantia al yape/plin 955507470 de Andres Talavera.
    <br>
    La diferencia al culminar el servicio. <br><br>
    Telefono de contacto: +51972598538, IG: @predicar.pe<br>
    Para regalarte revisi√≥n de due√±os, asesor√≠as y m√°s
  </p>

  <p>Atentamente</p>
  <p>Ingeniero Mecatronico - Andres Talavera</p>

  <button onclick="book()">Agendar</button>
  <p id="result"></p>

</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<!-- üîí TU JS ORIGINAL, SIN CAMBIOS -->
<script>
  const SUPABASE_URL = "https://lseahxqxcnmwfruoaubt.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZWFoeHF4Y25td2ZydW9hdWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMjMyOTUsImV4cCI6MjA4MDg5OTI5NX0.9OsARsYTPXJkpoS4cjGr2Z3Qp_cf5vzesK-0K-S0XEQ";
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadServices() {
    const { data } = await db.from("services").select("*");
    let html = "";
    if (data) {
      data.forEach(s => html += `<option value="${s.id}">${s.name}</option>`);
    }
    document.getElementById("services").innerHTML = html;
  }

  async function loadTimes() {
    const date = document.getElementById("date").value;
    if (!date) return;

    const now = new Date();
    const todayStr = now.toISOString().split("T")[0];

    if (new Date(date) < new Date(todayStr)) {
      document.getElementById("time").innerHTML = "";
      return;
    }

    const { data: blockedDates } = await db
      .from("blocked_dates")
      .select("id")
      .lte("start_date", date)
      .gte("end_date", date);

    if (blockedDates && blockedDates.length > 0) {
      document.getElementById("time").innerHTML = "";
      return;
    }

    const { data: ap } = await db.from("appointments").select("*").eq("date", date);
    const { data: bl } = await db.from("blocked_times").select("*").eq("date", date);

    const allTimes = ["08:00","10:30","13:00","15:30"];
    const occupied = [...ap.map(a=>a.time), ...bl.map(b=>b.time)];

    const free = allTimes.filter(t => {
      if (occupied.includes(t)) return false;

      const slot = new Date(date + "T" + t + ":00");
      if (date === todayStr && slot < now) return false;
      if (date === todayStr && (slot - now)/3600000 < 2) return false;
      return true;
    });

    document.getElementById("time").innerHTML =
      free.map(t => `<option>${t}</option>`).join("");
  }

  async function book() {
    const fileInput = document.getElementById("voucher");
    if (fileInput.files.length === 0) {
      document.getElementById("result").textContent =
        "Debes subir un comprobante antes de agendar.";
      return;
    }

    const service_id = services.value;
    const client_name = name.value;
    const client_email = email.value;
    const direccion = document.getElementById("direccion").value;
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    const payment_method = payment_method.value;

    const file = fileInput.files[0];
    const fileName = Date.now() + "_" + file.name;

    const { error: uploadError } = await db.storage
      .from("yape-comprobantes")
      .upload(fileName, file);

    if (uploadError) {
      document.getElementById("result").textContent =
        "Error al subir comprobante: " + uploadError.message;
      return;
    }

    const { data: publicUrl } = db.storage
      .from("yape-comprobantes")
      .getPublicUrl(fileName);

    const { data: cita, error } = await db
      .from("appointments")
      .insert({
        service_id,
        client_name,
        client_email,
        direccion,
        date,
        time,
        payment_method,
        status: "pending",
        created_at: new Date().toISOString()
      })
      .select()
      .single();

    if (error) {
      document.getElementById("result").textContent =
        "Error al registrar cita: " + error.message;
      return;
    }

    await db.from("yape_payments").insert({
      cita_id: cita.id,
      imagen_url: publicUrl.publicUrl,
      created_at: new Date().toISOString()
    });

    document.getElementById("result").textContent =
      "Cita registrada correctamente";
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadServices();
    document.getElementById("date").onchange = loadTimes;
  });
</script>

</body>
</html>
