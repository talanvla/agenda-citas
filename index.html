<!DOCTYPE html>
<html>
<head>
  <title>Agendar Cita</title>
</head>
<body>

<h1>Agenda tu cita</h1>

<label>Servicio:</label>
<select id="services"></select>
<br><br>

<label>Fecha:</label>
<input type="date" id="date">
<br><br>

<label>Hora:</label>
<select id="time">
  <option value="">Selecciona una fecha</option>
</select>
<br><br>

<label>Nombre:</label>
<input type="text" id="name">
<br><br>

<label>Email:</label>
<input type="email" id="email">
<br><br>

<label>Direcci√≥n de escaneo:</label>
<input type="text" id="direccion">
<br><br>

<label>M√©todo de pago:</label>
<select id="payment_method">
  <option value="yape">Yape</option>
  <option value="plin">Plin</option>
</select>
<br><br>

<label>Subir comprobante (imagen):</label>
<input type="file" id="voucher">
<br><br>

<h3>Distritos sin costo adicional:</h3>
<p>
San Isidro, San Borja, Miraflores, <br>
San Miguel, Magdalena, Jes√∫s Mar√≠a, Surco
</p>

<h4>Consideraciones</h4>
<p>
Para reservar la cita se debe abonar S/100 <br>
como garantia al yape/plin 955507470 de Andres Talavera.
<br>
La diferencia al culminar el servicio. <br><br>
Telefono de contacto: +51972598538, IG: @predicar.pe<br>
Para regalarte revisi√≥n de due√±os, asesor√≠as y m√°s
</p>

<p>Atentamente</p>
<p>Ingeniero Mecatronico - Andres Talavera</p>

<button onclick="book()">Agendar</button>
<p id="result"></p>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
const SUPABASE_URL = "https://lseahxqxcnmwfruoaubt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZWFoeHF4Y25td2ZydW9hdWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMjMyOTUsImV4cCI6MjA4MDg5OTI5NX0.9OsARsYTPXJkpoS4cjGr2Z3Qp_cf5vzesK-0K-S0XEQ";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===============================
   CARGAR SERVICIOS
================================ */
async function loadServices() {
  const { data } = await db.from("services").select("*");
  document.getElementById("services").innerHTML =
    data.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
}

/* ===============================
   CARGAR HORARIOS DISPONIBLES
================================ */
async function loadTimes() {
  const dateInput = document.getElementById("date").value;
  const timeSelect = document.getElementById("time");
  timeSelect.innerHTML = "";

  if (!dateInput) return;

  /* üö´ FECHAS PASADAS */
  const selectedDate = new Date(dateInput + "T00:00:00");
  const today = new Date();
  today.setHours(0,0,0,0);

  if (selectedDate < today) {
    timeSelect.innerHTML = `<option value="">Fecha no disponible</option>`;
    return;
  }

  const allTimes = ["08:00","10:30","13:00","15:00"];

  /* üìå CITAS YA RESERVADAS */
  const { data: appointments } = await db
    .from("appointments")
    .select("time")
    .eq("date", dateInput);

  const reservedTimes = (appointments || []).map(a => a.time);

  /* üìå BLOQUEOS MANUALES */
  const { data: blocks } = await db
    .from("blocked_times")
    .select("time, is_full_day")
    .eq("date", dateInput);

  /* üîí BLOQUEO DE D√çA COMPLETO */
  if (blocks?.some(b => b.is_full_day)) {
    timeSelect.innerHTML = `<option value="">D√≠a no disponible</option>`;
    return;
  }

  const blockedTimes = (blocks || [])
    .filter(b => b.time)
    .map(b => b.time);

  /* ‚è±Ô∏è REGLA DE 2 HORAS (SOLO HOY) */
  let availableTimes = allTimes.filter(t => {
    if (dateInput === today.toISOString().split("T")[0]) {
      const [h, m] = t.split(":");
      const slot = new Date();
      slot.setHours(h, m, 0, 0);
      return (slot - new Date()) >= 2 * 60 * 60 * 1000;
    }
    return true;
  });

  /* ‚ùå QUITAR RESERVADOS Y BLOQUEADOS */
  availableTimes = availableTimes.filter(
    t => !reservedTimes.includes(t) && !blockedTimes.includes(t)
  );

  if (availableTimes.length === 0) {
    timeSelect.innerHTML = `<option value="">Sin horarios disponibles</option>`;
    return;
  }

  availableTimes.forEach(t => {
    timeSelect.innerHTML += `<option value="${t}">${t}</option>`;
  });
}

/* ===============================
   AGENDAR CITA
================================ */
async function book() {
  const time = document.getElementById("time").value;
  if (!time) {
    document.getElementById("result").textContent =
      "Debes seleccionar una hora disponible.";
    return;
  }

  await db.from("appointments").insert({
    service_id: document.getElementById("services").value,
    client_name: document.getElementById("name").value,
    client_email: document.getElementById("email").value,
    direccion: document.getElementById("direccion").value,
    date: document.getElementById("date").value,
    time,
    payment_method: document.getElementById("payment_method").value,
    status: "pending"
  });

  document.getElementById("result").textContent = "‚úÖ Cita registrada correctamente";
  loadTimes();
}

/* ===============================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", () => {
  loadServices();
  document.getElementById("date").addEventListener("change", loadTimes);
});
</script>

</body>
</html>
