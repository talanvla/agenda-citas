<!DOCTYPE html>
<html>
<head>
  <title>Agendar Cita</title>
</head>

<body>
  <h1>Agenda tu cita</h1>

  <label>Servicio:</label>
  <select id="services"></select>
  <br><br>

  <label>Fecha:</label>
  <input type="date" id="date">
  <br><br>

  <label>Hora:</label>
  <select id="time"></select>
  <br><br>

  <label>Nombre:</label>
  <input type="text" id="name">
  <br><br>

  <label>Email:</label>
  <input type="email" id="email">
  <br><br>

  <label>Direcci√≥n de escaneo:</label>
  <input type="text" id="direccion">
  <br><br>

  <label>M√©todo de pago:</label>
  <select id="payment_method">
    <option value="yape">Yape</option>
    <option value="plin">Plin</option>
  </select>
  <br><br>

  <label>Subir comprobante (imagen):</label>
  <input type="file" id="voucher">
  <br><br>

  <button onclick="book()">Agendar</button>
  <p id="result"></p>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    const SUPABASE_URL = "https://lseahxqxcnmwfruoaubt.supabase.co";
    const SUPABASE_KEY = "TU_KEY_AQUI";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const ALL_TIMES = ["08:00","10:30","13:00","15:00"];

    // ======================
    // CARGAR SERVICIOS
    // ======================
    async function loadServices() {
      const { data } = await db.from("services").select("*");
      document.getElementById("services").innerHTML =
        data.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
    }

    // ======================
    // CARGAR HORAS DISPONIBLES
    // ======================
    async function loadTimes() {
      const date = document.getElementById("date").value;
      if (!date) return;

      // üîí Bloqueos por rango
      const { data: blocks } = await db
        .from("blocked_times")
        .select("*")
        .lte("start_date", date)
        .gte("end_date", date);

      // üö´ D√≠a completo bloqueado
      if (blocks?.some(b => b.full_day)) {
        document.getElementById("time").innerHTML = "";
        return;
      }

      const { data: ap } = await db
        .from("appointments")
        .select("time")
        .eq("date", date);

      const blockedHours = blocks
        ?.filter(b => b.time !== null)
        .map(b => b.time) || [];

      const occupied = [
        ...(ap || []).map(a => a.time),
        ...blockedHours
      ];

      const free = ALL_TIMES.filter(t => !occupied.includes(t));

      document.getElementById("time").innerHTML =
        free.map(t => `<option>${t}</option>`).join("");
    }

    // ======================
    // AGENDAR
    // ======================
    async function book() {
      const time = document.getElementById("time").value;

      // üö´ NO PERMITIR AGENDAR SIN HORARIO
      if (!time) {
        document.getElementById("result").textContent =
          "No hay horarios disponibles para esta fecha.";
        return;
      }

      const fileInput = document.getElementById("voucher");
      if (fileInput.files.length === 0) {
        document.getElementById("result").textContent =
          "Debes subir un comprobante.";
        return;
      }

      document.getElementById("result").textContent =
        "Cita registrada correctamente";
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadServices();
      document.getElementById("date").addEventListener("change", loadTimes);
    });
  </script>
</body>
</html>
