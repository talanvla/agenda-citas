<!DOCTYPE html>
<html>
<head>
  <title>Agendar Cita</title>
</head>
<body>

<h1>Agenda tu cita</h1>

<label>Servicio:</label>
<select id="services"></select>
<br><br>

<label>Fecha:</label>
<input type="date" id="date">
<br><br>

<label>Hora:</label>
<select id="time">
  <option value="">Selecciona una fecha</option>
</select>
<br><br>

<label>Nombre:</label>
<input type="text" id="name">
<br><br>

<label>Email:</label>
<input type="email" id="email">
<br><br>

<label>Dirección de escaneo:</label>
<input type="text" id="direccion">
<br><br>

<label>Método de pago:</label>
<select id="payment_method">
  <option value="yape">Yape</option>
  <option value="plin">Plin</option>
</select>
<br><br>

<label>Subir comprobante (imagen):</label>
<input type="file" id="voucher">
<br><br>

<button onclick="book()">Agendar</button>
<p id="result"></p>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
const SUPABASE_URL = "https://lseahxqxcnmwfruoaubt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZWFoeHF4Y25td2ZydW9hdWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMjMyOTUsImV4cCI6MjA4MDg5OTI5NX0.9OsARsYTPXJkpoS4cjGr2Z3Qp_cf5vzesK-0K-S0XEQ";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

async function loadServices() {
  const { data, error } = await db.from("services").select("*");
  if (error) return console.error(error);
  document.getElementById("services").innerHTML = data.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
}

async function loadTimes() {
  const date = document.getElementById("date").value;
  const timeSelect = document.getElementById("time");
  timeSelect.innerHTML = "";

  if (!date) return;

  const now = new Date();
  const allTimes = ["08:00","10:30","13:00","15:00"];

  // Obtener citas existentes
  const { data: appointments } = await db
    .from("appointments")
    .select("time")
    .eq("date", date);

  // Obtener bloqueos
  const { data: blockedTimes } = await db
    .from("blocked_times")
    .select("time, is_full_day, start_date, end_date")
    .or(`and(start_date.lte.${date},end_date.gte.${date})`);

  if (blockedTimes?.some(b => b.is_full_day)) {
    timeSelect.innerHTML = `<option value="">Día no disponible</option>`;
    return;
  }

  // Normalizar horas ocupadas a HH:MM
  const occupied = [
    ...(appointments || []).map(a => a.time.slice(0,5)),
    ...(blockedTimes || []).filter(b => !b.is_full_day).map(b => b.time)
  ];

  const free = allTimes.filter(t => {
    if (occupied.includes(t)) return false;

    // Solo aplicar regla de 2 horas si la fecha es hoy
    const todayStr = now.toISOString().slice(0,10);
    if (date === todayStr) {
      const [hour, minute] = t.split(":").map(Number);
      // Fecha exacta en hora local
      const appointmentDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
      const diffHours = (appointmentDate - now) / (1000*60*60);
      if (diffHours < 2) return false;
    }

    return true;
  });

  if (free.length === 0) {
    timeSelect.innerHTML = `<option value="">Sin horarios disponibles</option>`;
    return;
  }

  free.forEach(t => {
    timeSelect.innerHTML += `<option value="${t}">${t}</option>`;
  });
}

async function book() {
  const service_id = document.getElementById("services").value;
  const client_name = document.getElementById("name").value;
  const client_email = document.getElementById("email").value;
  const direccion = document.getElementById("direccion").value;
  const date = document.getElementById("date").value;
  const time = document.getElementById("time").value;
  const payment_method = document.getElementById("payment_method").value;
  const fileInput = document.getElementById("voucher");

  if (!time) return document.getElementById("result").textContent = "Selecciona una hora";
  if (fileInput.files.length === 0) return document.getElementById("result").textContent = "Sube comprobante";

  const file = fileInput.files[0];
  const fileName = Date.now() + "_" + file.name;

  const { error: uploadError } = await db.storage.from("yape-comprobantes").upload(fileName, file);
  if (uploadError) return document.getElementById("result").textContent = "Error: " + uploadError.message;

  const { data: publicUrl } = db.storage.from("yape-comprobantes").getPublicUrl(fileName);
  const voucherUrl = publicUrl.publicUrl;

  const { error: citaError } = await db.from("appointments").insert({
    service_id, client_name, client_email, direccion, date, time, payment_method,
    status: "pending",
    created_at: new Date().toISOString()
  });

  if (citaError) return document.getElementById("result").textContent = "Error: " + citaError.message;

  await db.from("yape_payments").insert({ imagen_url: voucherUrl, created_at: new Date().toISOString() });

  document.getElementById("result").textContent = "✅ Cita registrada correctamente";

  await loadTimes();
  document.getElementById("time").value = "";
}

document.addEventListener("DOMContentLoaded", () => {
  loadServices();
  document.getElementById("date").onchange = loadTimes;
});
</script>

</body>
</html>
