<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agendar Cita</title>

<style>
    body { font-family: Arial; max-width: 650px; margin: auto; padding: 20px; }
    label { font-weight:bold; margin-top: 10px; display:block; }
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; }
    .disponible { color: green; }
    .ocupado { color: red; }
</style>

</head>
<body>

<h2>Reserva tu cita</h2>

<!-- SERVICIO -->
<label>Servicio:</label>
<select id="services"></select>

<!-- DATOS -->
<label>Nombre:</label>
<input id="nombre">

<label>Email:</label>
<input id="email" type="email">

<label>Teléfono:</label>
<input id="telefono">

<label>Dirección:</label>
<input id="direccion">

<!-- FECHA -->
<label>Fecha:</label>
<input type="date" id="date">

<!-- HORAS -->
<label>Hora disponible:</label>
<select id="time">
 


<!-- FOTO DEL YAPE -->
<label>Foto del Yape:</label>
<input type="file" id="fotoYape" accept="image/*">

<button onclick="agendar()">Reservar cita</button>

<p id="mensaje"></p>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===========================================================
   CONFIGURAR SUPABASE
=========================================================== */
const URL = "https://lseahxqxcnmwfruoaubt.supabase.co";
const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZWFoeHF4Y25td2ZydW9hdWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMjMyOTUsImV4cCI6MjA4MDg5OTI5NX0.9OsARsYTPXJkpoS4cjGr2Z3Qp_cf5vzesK-0K-S0XEQ";
const BUCKET = "pagos-yape";

const supabase = supabase.createClient(URL, KEY);

/* ===========================================================
   1. CARGAR SERVICIOS DESDE LA TABLA `services`
=========================================================== */
async function cargarServicios() {
    const { data, error } = await supabase
        .from("services")
        .select("*");

    const sel = document.getElementById("servicio");
    sel.innerHTML = "<option value=''>Seleccione un servicio</option>";

    data.forEach(s => {
        const op = document.createElement("option");
        op.value = s.id;
        op.textContent = s.name;
        sel.appendChild(op);
    });
}

/* ===========================================================
   2. CARGAR HORAS DISPONIBLES
      Usa:
      - tabla blocked_times
      - tabla citas
=========================================================== */
async function cargarHoras() {
    const fecha = document.getElementById("fecha").value;
    const horaSel = document.getElementById("hora");

    if (!fecha) return;

    horaSel.innerHTML = "<option>Cargando...</option>";

    // horario base (ajusta si deseas)
    const horas = ["09:00","10:00","11:00","14:00","15:00","16:00"];

    // horas bloqueadas manualmente
    const { data: bloqueadas } = await supabase
        .from("blocked_times")
        .select("hora")
        .eq("fecha", fecha);

    // horas ocupadas por citas aprobadas o pendientes
    const { data: citas } = await supabase
        .from("citas")
        .select("hora, estado")
        .eq("fecha", fecha);

    horaSel.innerHTML = "";

    horas.forEach(h => {
        const estaBloqueada = bloqueadas?.some(b => b.hora === h);
        const ocupada = citas?.some(c =>
            c.hora === h && c.estado !== "rechazada"
        );

        const opt = document.createElement("option");
        opt.value = h;

        if (estaBloqueada || ocupada) {
            opt.textContent = h + " - Ocupado";
            opt.disabled = true;
        } else {
            opt.textContent = h;
        }
        horaSel.appendChild(opt);
    });
}

/* ===========================================================
   3. REGISTRAR CITA + SUBIR FOTO YAPE
      Inserta:
      - en citas
      - en yape_payments
=========================================================== */
async function agendar() {
    const nombre = document.getElementById("nombre").value;
    const email = document.getElementById("email").value;
    const telefono = document.getElementById("telefono").value;
    const direccion = document.getElementById("direccion").value;
    const servicio_id = document.getElementById("servicio").value;
    const fecha = document.getElementById("fecha").value;
    const hora = document.getElementById("hora").value;
    const foto = document.getElementById("fotoYape").files[0];

    const m = document.getElementById("mensaje");

    if (!nombre || !email || !telefono || !direccion || !servicio_id || !fecha || !hora || !foto) {
        m.innerHTML = "Completa todos los campos.";
        return;
    }

    // Subir imagen a bucket
    const nombreArchivo = Date.now() + "-" + foto.name;

    const { error: uploadError } = await supabase.storage
        .from(BUCKET)
        .upload(nombreArchivo, foto);

    if (uploadError) {
        m.innerHTML = "Error subiendo imagen.";
        return;
    }

    const { data: urlData } = supabase.storage
        .from(BUCKET)
        .getPublicUrl(nombreArchivo);

    // Insertar cita
    const { data: cita, error: citaError } = await supabase
        .from("citas")
        .insert([{
            nombre,
            email,
            telefono,
            direccion,
            servicio_id,
            fecha,
            hora,
            estado: "pendiente_validación"
        }])
        .select()
        .single();

    if (citaError) {
        m.innerHTML = "Error creando cita.";
        return;
    }

    // insertar pago Yape
    await supabase
        .from("yape_payments")
        .insert([{
            cita_id: cita.id,
            imagen_url: urlData.publicUrl
        }]);

    m.innerHTML = "Cita registrada. Pendiente de validación del pago.";
}

cargarServicios();
</script>
</body>
</html>
