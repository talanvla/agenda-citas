<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Agendar Cita</title>

<style>
    body { font-family: Arial; max-width: 650px; margin: auto; padding: 20px; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, button { width: 100%; padding: 10px; margin-top: 5px; }
    .disponible { color: green; font-weight: bold; }
    .ocupado { color: red; font-weight: bold; }
</style>
</head>
<body>

<h2>Reserva tu Cita</h2>

<!-- SERVICIO -->
<label>Servicio:</label>
<select id="servicio">
    <option value="">Seleccione un servicio</option>
    <option value="Consulta general">Consulta general</option>
    <option value="Terapia">Terapia</option>
    <option value="Control">Control</option>
</select>

<!-- DATOS DEL CLIENTE -->
<label>Nombre completo:</label>
<input id="nombre" placeholder="Tu nombre">

<label>Email:</label>
<input id="email" type="email" placeholder="tucorreo@gmail.com">

<label>Teléfono:</label>
<input id="telefono" placeholder="999999999">

<label>Dirección:</label>
<input id="direccion" placeholder="Tu dirección">

<!-- FECHA -->
<label>Fecha:</label>
<input type="date" id="fecha" onchange="cargarHoras()">

<!-- HORAS DISPONIBLES -->
<label>Hora disponible:</label>
<select id="hora">
    <option value="">Selecciona una fecha primero</option>
</select>

<!-- FOTO DEL YAPE -->
<label>Foto del pago Yape:</label>
<input type="file" id="fotoYape" accept="image/*">

<button onclick="agendar()">Reservar cita</button>

<p id="mensaje"></p>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ============================================
      CONFIGURACIÓN SUPABASE
=============================================== */
const SUPABASE_URL = "https://lseahxqxcnmwfruoaubt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZWFoeHF4Y25td2ZydW9hdWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMjMyOTUsImV4cCI6MjA4MDg5OTI5NX0.9OsARsYTPXJkpoS4cjGr2Z3Qp_cf5vzesK-0K-S0XEQ";
const BUCKET = "yape-payments"; // Usa el tuyo

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============================================
      CARGAR HORAS DISPONIBLES
=============================================== */
async function cargarHoras() {
    const fecha = document.getElementById("fecha").value;
    const horaSelect = document.getElementById("hora");
    horaSelect.innerHTML = "<option>Cargando...</option>";

    if (!fecha) return;

    // Define tus rangos de horas normales según tu código original
    const horas = [
        "09:00", "10:00", "11:00",
        "14:00", "15:00", "16:00"
    ];

    // Consulta supabase para ver citas ocupadas
    const { data: citas } = await supabase
        .from("citas")
        .select("hora, estado")
        .eq("fecha", fecha);

    horaSelect.innerHTML = "";

    horas.forEach(h => {
        const ocupada = citas?.some(c =>
            c.hora === h && c.estado !== "rechazada"
        );

        const option = document.createElement("option");
        option.value = h;
        option.textContent = ocupada ? `${h} - Ocupado` : h;

        if (ocupada) option.disabled = true;

        horaSelect.appendChild(option);
    });
}

/* ============================================
      AGENDAR CITA
=============================================== */
async function agendar() {
    const nombre = document.getElementById("nombre").value;
    const email = document.getElementById("email").value;
    const telefono = document.getElementById("telefono").value;
    const direccion = document.getElementById("direccion").value;
    const servicio = document.getElementById("servicio").value;

    const fecha = document.getElementById("fecha").value;
    const hora = document.getElementById("hora").value;
    const foto = document.getElementById("fotoYape").files[0];

    const mensaje = document.getElementById("mensaje");

    if (!servicio || !nombre || !email || !telefono || !direccion || !fecha || !hora || !foto) {
        mensaje.innerHTML = "Por favor completa todos los campos.";
        return;
    }

    // Subir la imagen al bucket
    const nombreArchivo = Date.now() + "-" + foto.name;

    const { error: uploadError } = await supabase.storage
        .from(BUCKET)
        .upload(nombreArchivo, foto);

    if (uploadError) {
        mensaje.innerHTML = "Error subiendo la imagen del Yape.";
        return;
    }

    const { data: urlImagen } = supabase.storage
        .from(BUCKET)
        .getPublicUrl(nombreArchivo);

    // Registrar cita en estado pendiente_validación
    const { error: insertError } = await supabase
        .from("citas")
        .insert([
            {
                servicio,
                nombre,
                email,
                telefono,
                direccion,
                fecha,
                hora,
                estado: "pendiente_validación",
                imagen_yape: urlImagen.publicUrl
            }
        ]);

    if (insertError) {
        mensaje.innerHTML = "Error registrando la cita.";
        return;
    }

    mensaje.innerHTML = "Tu cita fue registrada y está pendiente de validación del pago.";
}
</script>

</body>
</html>
