<!DOCTYPE html>
<html>
<head>
  <title>Agendar Cita</title>
</head>
<body>
  <h1>Agenda tu cita</h1>

  <label>Servicio:</label>
  <select id="services"></select>
  <br><br>

  <label>Fecha:</label>
  <input type="date" id="date">
  <br><br>

  <label>Hora:</label>
  <select id="time"></select>
  <br><br>

  <label>Nombre:</label>
  <input type="text" id="name">
  <br><br>

  <label>Email:</label>
  <input type="email" id="email">
  <br><br>

  <label>Dirección de escaneo:</label>
  <input type="text" id="direccion">
  <br><br>

  <label>Método de pago:</label>
  <select id="payment_method">
    <option value="yape">Yape</option>
    <option value="plin">Plin</option>

  </select>
<br><br>

  <label>Subir comprobante (imagen):</label>
  <input type="file" id="voucher">
 

  <h3>Distritos sin costo adicional:</h3>
  <p>San Isidro, San Borja, Miraflores, <br>
San Miguel, Magdalena, Jesús María, Surco</p>

<h4>Consideraciones </h4>
<p>Para reservar la cita se debe abonar S/100 <br>
como garantia al yape/plin 955507470 de Andres Talavera. 
<br>
La diferencia al culminar el servicio. <br><br>
Telefono de contacto: +51972598538, IG: @predicar.pe<br> 
Para regalarte revisión de dueños, asesorías y más

<p>Atentamente</p>
<p>Ingeniero Mecatronico - Andres Talavera</p>





  <button onclick="book()">Agendar</button>
  <p id="result"></p>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = "https://lseahxqxcnmwfruoaubt.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZWFoeHF4Y25td2ZydW9hdWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMjMyOTUsImV4cCI6MjA4MDg5OTI5NX0.9OsARsYTPXJkpoS4cjGr2Z3Qp_cf5vzesK-0K-S0XEQ";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ------------------------------
    // Cargar servicios
    // ------------------------------
    async function loadServices() {
      const { data } = await db.from("services").select("*");
      let html = "";
      if (data) {
        data.forEach(s => html += `<option value="${s.id}">${s.name}</option>`);
      }
      document.getElementById("services").innerHTML = html;
    }

    // ------------------------------
    // Cargar horas disponibles
    // ------------------------------
    async function loadTimes() {
      const date = document.getElementById("date").value;
      if (!date) return;

      const now = new Date();
      const todayStr = now.toISOString().split("T")[0];

      if (new Date(date) < new Date(todayStr)) {
        document.getElementById("time").innerHTML = "";
        return;
      }

      const { data: ap } = await db.from("appointments").select("*").eq("date", date);
      const { data: bl } = await db.from("blocked_times").select("*").eq("date", date);

      const allTimes = ["08:00","10:30","13:00","15:30"];
      const occupied = [...ap.map(a=>a.time), ...bl.map(b=>b.time)];

      const free = allTimes.filter(t => {
        if (occupied.includes(t)) return false;

        const [h,m] = t.split(":");
        const slot = new Date(date + "T" + h + ":" + m + ":00");

        if (date === todayStr && slot < now) return false;

        const diffHours = (slot - now)/3600000;
        if (date === todayStr && diffHours < 2) return false;

        return true;
      });

      let html = "";
      free.forEach(t => html += `<option>${t}</option>`);
      document.getElementById("time").innerHTML = html;
    }

    // ------------------------------
    // Agendar cita + subir comprobante
    // ------------------------------
    async function book() {
      const fileInput = document.getElementById("voucher");

      // ✅ Validar que haya archivo
      if (fileInput.files.length === 0) {
        document.getElementById("result").textContent = "Debes subir un comprobante antes de agendar.";
        return;
      }

      const service_id = document.getElementById("services").value;
      const client_name = document.getElementById("name").value;
      const client_email = document.getElementById("email").value;
      const direccion = document.getElementById("direccion").value;
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const payment_method = document.getElementById("payment_method").value;

      // 1️⃣ Subir comprobante primero
      const file = fileInput.files[0];
      const fileName = Date.now() + "_" + file.name;

      let { data: uploadData, error: uploadError } = await db.storage.from("yape-comprobantes").upload(fileName, file);
      if (uploadError) {
        document.getElementById("result").textContent = "Error al subir comprobante: " + uploadError.message;
        return;
      }

      const { data: publicUrl } = db.storage.from("yape-comprobantes").getPublicUrl(fileName);
      const voucherUrl = publicUrl.publicUrl;

      // 2️⃣ Insertar cita en appointments
      let { data: cita, error: citaError } = await db.from("appointments").insert({
        service_id,
        client_name,
        client_email,
        direccion,
        date,
        time,
        payment_method,
        status: "pending",
        created_at: new Date().toISOString()
      }).select().single();

      if (citaError) {
        document.getElementById("result").textContent = "Error al registrar cita: " + citaError.message;
        return;
      }

      // 3️⃣ Insertar en yape_payments
      let { error: paymentError } = await db.from("yape_payments").insert({
        cita_id: cita.id,
        imagen_url: voucherUrl,
        created_at: new Date().toISOString()
      });

      if (paymentError) {
        document.getElementById("result").textContent = "Error al registrar comprobante: " + paymentError.message;
        return;
      }

      document.getElementById("result").textContent = "Cita registrada correctamente";
    }

    // ------------------------------
    // Ejecutar cuando DOM esté listo
    // ------------------------------
    document.addEventListener("DOMContentLoaded", () => {
      loadServices();
      document.getElementById("date").onchange = loadTimes;
    });
  </script>
</body>
</html>
