<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agendar Cita | Servicio TÃ©cnico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <!-- HEADER -->
  <header class="header">
    <h1>Agenda tu cita tÃ©cnica</h1>
    <p>Servicio profesional a domicilio</p>
  </header>

  <!-- CONTENEDOR -->
  <main class="container">
    <section class="card">

      <h2>Formulario de reserva</h2>

      <label>Servicio</label>
      <select id="services"></select>

      <label>Fecha</label>
      <input type="date" id="date">

      <label>Hora</label>
      <select id="time"></select>

      <label>Nombre completo</label>
      <input type="text" id="name">

      <label>Email</label>
      <input type="email" id="email">

      <label>DirecciÃ³n de escaneo</label>
      <input type="text" id="direccion">

      <label>MÃ©todo de pago</label>
      <select id="payment_method">
        <option value="yape">Yape</option>
        <option value="plin">Plin</option>
      </select>

      <label>Subir comprobante (imagen)</label>
      <input type="file" id="voucher" accept="image/*">

      <button onclick="book()">Agendar cita</button>

      <p id="result"></p>

      <div class="info">
        <strong>Distritos sin costo adicional:</strong><br>
        San Isidro, Miraflores, Surco, San Borja, JesÃºs MarÃ­a
        <br><br>
        <strong>Pago:</strong> S/100 por Yape o Plin<br>
        ðŸ“ž 972 598 538 â€” IG: @predicar.pe
      </div>

    </section>
  </main>

  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    const SUPABASE_URL = "https://lseahxqxcnmwfruoaubt.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzZWFoeHF4Y25td2ZydW9hdWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMjMyOTUsImV4cCI6MjA4MDg5OTI5NX0.9OsARsYTPXJkpoS4cjGr2Z3Qp_cf5vzesK-0K-S0XEQ";

    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function loadServices() {
      const { data } = await db.from("services").select("*");
      document.getElementById("services").innerHTML =
        data.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
    }

    async function loadTimes() {
      const date = document.getElementById("date").value;
      if (!date) return;

      const now = new Date();
      const todayStr = now.toISOString().split("T")[0];

      if (new Date(date) < new Date(todayStr)) {
        document.getElementById("time").innerHTML = "";
        return;
      }

      const { data: ap } = await db.from("appointments").select("*").eq("date", date);
      const { data: bl } = await db.from("blocked_times").select("*").eq("date", date);

      const allTimes = ["08:00", "10:30", "13:00", "15:00"];
      const occupied = [...ap.map(a => a.time), ...bl.map(b => b.time)];

      const free = allTimes.filter(t => {
        if (occupied.includes(t)) return false;
        const slot = new Date(date + "T" + t + ":00");
        if (date === todayStr && slot < now) return false;
        if (date === todayStr && (slot - now) / 3600000 < 2) return false;
        return true;
      });

      document.getElementById("time").innerHTML =
        free.map(t => `<option>${t}</option>`).join("");
    }

    async function book() {
      const fileInput = document.getElementById("voucher");
      if (fileInput.files.length === 0) {
        document.getElementById("result").textContent =
          "Debes subir un comprobante antes de agendar.";
        return;
      }

      const file = fileInput.files[0];
      const fileName = Date.now() + "_" + file.name;

      const { error: uploadError } =
        await db.storage.from("yape-comprobantes").upload(fileName, file);

      if (uploadError) {
        document.getElementById("result").textContent =
          "Error al subir comprobante.";
        return;
      }

      const { data: publicUrl } =
        db.storage.from("yape-comprobantes").getPublicUrl(fileName);

      const { data: cita, error } = await db.from("appointments")
        .insert({
          service_id: document.getElementById("services").value,
          client_name: document.getElementById("name").value,
          client_email: document.getElementById("email").value,
          direccion: document.getElementById("direccion").value,
          date: document.getElementById("date").value,
          time: document.getElementById("time").value,
          payment_method: document.getElementById("payment_method").value,
          status: "pending",
          created_at: new Date().toISOString()
        }).select().single();

      if (error) {
        document.getElementById("result").textContent =
          "Error al registrar cita.";
        return;
      }

      await db.from("yape_payments").insert({
        cita_id: cita.id,
        imagen_url: publicUrl.publicUrl,
        created_at: new Date().toISOString()
      });

      document.getElementById("result").textContent =
        "âœ… Cita registrada correctamente";
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadServices();
      document.getElementById("date").onchange = loadTimes;
    });
  </script>

</body>
</html>
